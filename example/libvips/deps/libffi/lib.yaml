name: libffi
type: autotools
source:
  git:
    url: https://github.com/libffi/libffi.git
    ref: v3.5.2
license: LICENSE

flags:
  c: -fPIC -O2
  cxx: -fPIC -O2
  cpp: ""
  ld: ""

# libffi requires autoreconf but the LT_SYS_SYMBOL_USCORE macro may be missing
# on some systems. We add it manually before running autoreconf.
precompile:
  - bash -c 'printf "dnl LT_SYS_SYMBOL_USCORE - check if symbols have underscore prefix\ndnl For Android/Linux, symbols typically do not have underscore prefix\nAC_DEFUN([LT_SYS_SYMBOL_USCORE],\n[AC_MSG_CHECKING([whether symbols have underscore prefix])\nsys_symbol_underscore=no\nAC_MSG_RESULT([\$sys_symbol_underscore])\n])\n" > m4/lt_symbol_uscore.m4'
  - ./autogen.sh

options:
  - --disable-docs
  - --disable-multi-os-directory
  - --enable-static
  - --disable-shared

# libffi 在交叉编译时有 bug，需要手动生成 fficonfig.h
hooks:
  post_configure:
    # iOS 平台
    - platform: ios
      script: |
        BUILD_SUBDIR="$SOURCE_DIR/$HOST"
        if [ -d "$BUILD_SUBDIR" ]; then
          cd "$BUILD_SUBDIR"
          if [ ! -f fficonfig.h ] || [ ! -s fficonfig.h ]; then
            echo "Generating fficonfig.h for iOS cross-compilation..."
            cat > fficonfig.h << 'FFICONFIG_EOF'
        /* fficonfig.h - Generated for iOS cross-compilation */
        #define STDC_HEADERS 1
        #define HAVE_ALLOCA_H 1
        #define HAVE_MEMCPY 1
        #define HAVE_INTTYPES_H 1
        #define HAVE_STDINT_H 1
        #define HAVE_STDLIB_H 1
        #define HAVE_STRING_H 1
        #define HAVE_SYS_STAT_H 1
        #define HAVE_SYS_TYPES_H 1
        #define HAVE_UNISTD_H 1
        #define HAVE_DLFCN_H 1
        #define SIZEOF_SIZE_T 8
        #define SIZEOF_DOUBLE 8
        #define SIZEOF_LONG_DOUBLE 8
        #define HAVE_LONG_DOUBLE 1
        #define HAVE_AS_CFI_PSEUDO_OP 1
        #define HAVE_HIDDEN_VISIBILITY_ATTRIBUTE 1
        #define FFI_EXEC_TRAMPOLINE_TABLE 1
        #define EH_FRAME_FLAGS "aw"
        #ifdef LIBFFI_ASM
        #ifdef __APPLE__
        #define FFI_HIDDEN(name) .private_extern name
        #else
        #define FFI_HIDDEN(name) .hidden name
        #endif
        #else
        #define FFI_HIDDEN __attribute__ ((visibility ("hidden")))
        #endif
        FFICONFIG_EOF
            echo "fficonfig.h generated"
          fi
        fi
    # Android 平台
    - platform: android
      script: |
        # libffi configure 会创建以 HOST 命名的子目录
        # 根据 ARCH 确定正确的子目录前缀
        case "$ARCH" in
          arm64-v8a)
            ARCH_PREFIX="aarch64"
            ;;
          armeabi-v7a)
            ARCH_PREFIX="arm"
            ;;
          x86)
            ARCH_PREFIX="i686"
            ;;
          x86_64)
            ARCH_PREFIX="x86_64"
            ;;
          *)
            ARCH_PREFIX=""
            ;;
        esac
        
        # 查找匹配当前架构的子目录
        BUILD_SUBDIR=""
        if [ -n "$ARCH_PREFIX" ]; then
          BUILD_SUBDIR=$(find "$SOURCE_DIR" -maxdepth 1 -type d -name "${ARCH_PREFIX}-*-linux-android*" 2>/dev/null | head -1)
        fi
        
        if [ -z "$BUILD_SUBDIR" ] || [ ! -d "$BUILD_SUBDIR" ]; then
          echo "Warning: Could not find libffi build subdirectory for $ARCH (prefix: $ARCH_PREFIX)"
          exit 0
        fi
        
        echo "Found build subdir: $BUILD_SUBDIR"
        cd "$BUILD_SUBDIR"
        
        if [ ! -f fficonfig.h ] || [ ! -s fficonfig.h ]; then
          echo "Generating fficonfig.h for Android cross-compilation..."
          if [ "$ARCH" = "arm64-v8a" ] || [ "$ARCH" = "x86_64" ]; then
            SIZEOF_SIZE_T=8
          else
            SIZEOF_SIZE_T=4
          fi
          cat > fficonfig.h << 'FFICONFIG_EOF'
        /* fficonfig.h - Generated for Android cross-compilation */
        #define STDC_HEADERS 1
        #define HAVE_ALLOCA_H 1
        #define HAVE_MEMCPY 1
        #define HAVE_INTTYPES_H 1
        #define HAVE_STDINT_H 1
        #define HAVE_STDLIB_H 1
        #define HAVE_STRING_H 1
        #define HAVE_SYS_STAT_H 1
        #define HAVE_SYS_TYPES_H 1
        #define HAVE_UNISTD_H 1
        #define HAVE_DLFCN_H 1
        #define SIZEOF_DOUBLE 8
        #define SIZEOF_LONG_DOUBLE 8
        #define HAVE_LONG_DOUBLE 1
        #define HAVE_AS_CFI_PSEUDO_OP 1
        #define HAVE_HIDDEN_VISIBILITY_ATTRIBUTE 1
        #define EH_FRAME_FLAGS "aw"
        #ifdef LIBFFI_ASM
        #define FFI_HIDDEN(name) .hidden name
        #else
        #define FFI_HIDDEN __attribute__ ((visibility ("hidden")))
        #endif
        FFICONFIG_EOF
          sed -i '' "s/SIZEOF_SIZE_T_PLACEHOLDER/$SIZEOF_SIZE_T/" fficonfig.h 2>/dev/null || sed -i "s/SIZEOF_SIZE_T_PLACEHOLDER/$SIZEOF_SIZE_T/" fficonfig.h
          echo "#define SIZEOF_SIZE_T $SIZEOF_SIZE_T" >> fficonfig.h
          echo "fficonfig.h generated for $ARCH (SIZEOF_SIZE_T=$SIZEOF_SIZE_T)"
        fi
